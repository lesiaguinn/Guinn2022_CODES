
clc; close all;
% x1 = x-axis, time
%y1 = mean of each time point
%e1 = stdev;

%% 0.5% Sugar TBR1

t=[0	1.027694444	2.055361111	3.083055556	4.110722222	5.138416667	6.166111111	7.193777778	8.221472222	9.249166667	10.27686111	11.30452778	12.33222222	13.35988889	14.38758333	15.41527778	16.44294444	17.47063889	18.49833333	19.526	20.55369444	21.58136111	22.60905556	23.63672222	24.66441667	25.69211111	26.71977778	27.74747222	28.77513889	29.80283333	30.83052778	31.85819444	32.88588889	33.91358333	34.94125	35.96894444	36.99663889	38.02430556	39.052	40.07969444	41.10736111	42.13505556	43.16275	44.19041667	45.21811111	46.24577778	47.27347222	48.30116667	49.32886111	50.35652778	51.38422222	52.41188889	53.43958333	54.46727778	55.49494444	56.52263889	57.55033333	58.578	59.60569444	60.63338889	61.66105556	62.68875	63.71644444	64.74411111	65.77180556	66.7995	67.82716667	68.85486111	69.88255556	70.91022222	71.93791667	72.96561111];
% errorbar(x1,y1,err1);

scy1 = [0.163133334	0.181000005	0.215199998	0.260666664	0.323133325	0.398099995	0.488766666	0.564666665	0.588933345	0.597333328	0.601133342	0.603166656	0.603566662	0.606199996	0.608966664	0.610700007	0.612766679	0.614599979	0.615566687	0.618066664	0.619000014	0.618833339	0.620366688	0.621700005	0.622166649	0.622900005	0.623600002	0.624399996	0.624700006	0.62640001	0.6261	0.627566671	0.627666668	0.629033323	0.629933333	0.629866656	0.63093332	0.630433337	0.632233337	0.632566667	0.632999992	0.633733328	0.634433345	0.635166681	0.635633325	0.63609999	0.635633325	0.636433339	0.636366661	0.636133349	0.636300003	0.63823334	0.637966669	0.639166669	0.639866686	0.640266673	0.640866653	0.641033327	0.640333331	0.642033334	0.642333345	0.643000003	0.643599983	0.643966651	0.644333339	0.644566671	0.645300007	0.6455	0.645633356	0.646266675	0.646200017	0.646600004];
sclo1 = [0.156541422	0.172284503	0.203667434	0.242702164	0.298545872	0.367839957	0.449732012	0.51709732	0.538016014	0.546580347	0.551032482	0.552916425	0.554502382	0.556597298	0.559816433	0.561298791	0.563216472	0.564998764	0.566166651	0.568356952	0.569240894	0.569182914	0.571216486	0.572749941	0.573066604	0.573585084	0.574332866	0.575089028	0.575688991	0.57734626	0.576692407	0.578063316	0.578309574	0.579832478	0.580732488	0.580597964	0.581881882	0.581515301	0.583580219	0.583560924	0.584080386	0.585115202	0.585529213	0.586557914	0.587075069	0.587443751	0.587098149	0.587698302	0.58743394	0.587504529	0.587402049	0.589391529	0.588980701	0.590445279	0.591033884	0.591320028	0.5919927	0.591651927	0.591138184	0.593023481	0.593010511	0.593622584	0.594275359	0.594402521	0.594715562	0.594898152	0.595585229	0.595763472	0.595838744	0.596206487	0.596041369	0.596417062];
schi1 = [0.169725246	0.189715507	0.226732561	0.278631164	0.347720779	0.428360032	0.527801321	0.612236009	0.639850676	0.648086309	0.651234203	0.653416887	0.652630943	0.655802693	0.658116896	0.660101224	0.662316886	0.664201194	0.664966722	0.667776376	0.668759134	0.668483764	0.66951689	0.670650068	0.671266695	0.672214927	0.672867138	0.673710963	0.67371102	0.675453759	0.675507592	0.677070027	0.677023762	0.678234168	0.679134179	0.679135347	0.679984759	0.679351372	0.680886455	0.681572409	0.681919599	0.682351454	0.683337477	0.683775447	0.684191582	0.68475623	0.684168502	0.685168377	0.685299383	0.684762169	0.685197958	0.687075151	0.686952636	0.687888059	0.688699487	0.689213318	0.689740606	0.690414728	0.689528477	0.691043188	0.691656178	0.692377421	0.692924607	0.693530781	0.693951116	0.694235189	0.695014785	0.695236528	0.695427967	0.696326863	0.696358665	0.696782946];

y1 = log(scy1);
lo1 = log(sclo1);
hi1 = log(schi1);

% 1% Sugar TBR1 
% errorbar(x1,y1,err1);

scy2 = [0.16313333	0.179166661	0.208566672	0.249266671	0.301133331	0.369633324	0.455966668	0.558933324	0.672299988	0.744366672	0.763500002	0.766866671	0.765866684	0.766966687	0.768633333	0.768766688	0.769500004	0.770366675	0.771299985	0.773366676	0.774300006	0.7757	0.7757	0.776633329	0.777366665	0.778133339	0.779133326	0.779666669	0.780466663	0.78176666	0.781833337	0.781400012	0.782699989	0.783966667	0.783799993	0.784600006	0.78510001	0.786166655	0.787166662	0.788233327	0.788699971	0.788933343	0.789466686	0.790299998	0.792000002	0.791533338	0.791366663	0.793800003	0.791933325	0.79266668	0.794666674	0.793866661	0.796233343	0.798533347	0.799233344	0.798866676	0.797066675	0.796966659	0.797766652	0.799099988	0.799800005	0.803066658	0.801800019	0.804266658	0.805199987	0.806066659	0.807699985	0.805299984	0.806300011	0.808266666	0.806833333	0.809499986];
sclo2 = [0.156541419	0.170716613	0.197751713	0.233515382	0.281833246	0.345924181	0.428734271	0.528567845	0.639272132	0.712239987	0.731008323	0.734561518	0.732908799	0.734514529	0.736183302	0.735514568	0.735799987	0.736816671	0.737949854	0.741505669	0.741940616	0.7438301	0.742895897	0.743366205	0.744601075	0.745359846	0.746265942	0.746834909	0.74780992	0.748366613	0.748033136	0.747536598	0.74889821	0.750112211	0.750399517	0.751424578	0.752892581	0.752558273	0.754488492	0.754278897	0.755092829	0.754781279	0.755149152	0.757140851	0.75872374	0.758659898	0.75669646	0.759356443	0.757828451	0.75849984	0.760764726	0.759174801	0.761925849	0.76342605	0.765168064	0.764801699	0.763043987	0.762389451	0.763189443	0.764901595	0.765137616	0.769416482	0.766915648	0.76988579	0.770688526	0.771108925	0.773856673	0.769991065	0.771802057	0.772702465	0.771409825	0.77504248];
schi2 = [0.16972524	0.18761671	0.219381632	0.26501796	0.320433417	0.393342466	0.483199065	0.589298803	0.705327843	0.776493358	0.795991681	0.799171823	0.798824568	0.799418846	0.801083363	0.802018808	0.803200021	0.80391668	0.804650116	0.805227684	0.806659395	0.807569899	0.808504102	0.809900452	0.810132255	0.810906833	0.812000711	0.812498428	0.813123405	0.815166706	0.815633538	0.815263425	0.816501768	0.817821123	0.817200469	0.817775434	0.817307439	0.819775036	0.819844831	0.822187756	0.822307114	0.823085407	0.82378422	0.823459146	0.825276265	0.824406778	0.826036866	0.828243563	0.826038198	0.826833521	0.828568623	0.828558521	0.830540836	0.833640644	0.833298624	0.832931653	0.831089363	0.831543866	0.832343862	0.833298382	0.834462394	0.836716834	0.83668439	0.838647526	0.839711449	0.841024393	0.841543297	0.840608903	0.840797965	0.843830867	0.842256842	0.843957491];

y2 = log(scy2);
lo2 = log(sclo2);
hi2 = log(schi2);
% 2% Sugar TBR1 
% errorbar(x1,y1,err1);

scy3 = [0.163133336	0.191933336	0.228799996	0.280366676	0.347766665	0.433599996	0.54270001	0.670233326	0.811566648	0.95409999	1.084466673	1.168333349	1.190666653	1.197566646	1.199900008	1.20136668	1.202833352	1.204266684	1.205266691	1.205533323	1.205600001	1.206200021	1.207366682	1.207933324	1.208500005	1.209799982	1.209599989	1.210599996	1.211299953	1.212633349	1.212233322	1.214566685	1.214600024	1.215866662	1.216766653	1.218500035	1.219133354	1.220099983	1.221200006	1.222566661	1.22443332	1.225400028	1.226100025	1.227433341	1.229099966	1.2305	1.231766678	1.233633337	1.234666682	1.235533334	1.236166693	1.237700003	1.238966641	1.239966688	1.241866685	1.242666659	1.243366616	1.244366663	1.244599995	1.246033328	1.247100013	1.247733332	1.248533345	1.249666668	1.250200011	1.250900008	1.251899975	1.252399978	1.252866643	1.25356664	1.254333354	1.25476664];
sclo3 = [0.156541423	0.164654708	0.20158842	0.252714491	0.319689555	0.404006589	0.511444141	0.638461425	0.779307641	0.922830856	1.055028335	1.14086255	1.162802294	1.169194081	1.171817784	1.173245068	1.174770869	1.176124124	1.176691808	1.177469058	1.177540045	1.178543355	1.179440094	1.180198796	1.180704525	1.181982202	1.181855225	1.182741233	1.183590199	1.185236961	1.184615521	1.186723103	1.186985361	1.18826643	1.189343967	1.191000743	1.191589509	1.192885241	1.193870361	1.195123923	1.197331762	1.198219302	1.198939913	1.200291218	1.201877003	1.2033935	1.204642433	1.206342062	1.207034037	1.207957165	1.208608529	1.209915881	1.211598535	1.212788544	1.214837556	1.21535837	1.216266556	1.21730335	1.217344858	1.218911664	1.219749881	1.220367236	1.221506689	1.222547586	1.223024275	1.223648746	1.22470497	1.225639409	1.225822924	1.226522921	1.226987002	1.227477586];
schi3 = [0.169725249	0.219211964	0.256011572	0.308018862	0.375843775	0.463193402	0.573955879	0.702005228	0.843825655	0.985369124	1.113905011	1.195804147	1.218531012	1.22593921	1.227982233	1.229488292	1.230895835	1.232409245	1.233841575	1.233597588	1.233659957	1.233856686	1.235293271	1.235667852	1.236295485	1.237617762	1.237344753	1.238458758	1.239009707	1.240029737	1.239851124	1.242410267	1.242214687	1.243466894	1.244189338	1.245999327	1.2466772	1.247314724	1.248529652	1.2500094	1.251534878	1.252580754	1.253260136	1.254575464	1.25632293	1.2576065	1.258890923	1.260924612	1.262299328	1.263109503	1.263724857	1.265484124	1.266334747	1.267144831	1.268895814	1.269974948	1.270466676	1.271429976	1.271855133	1.273154992	1.274450145	1.275099427	1.275560002	1.276785751	1.277375746	1.278151269	1.27909498	1.279160548	1.279910362	1.280610359	1.281679707	1.282055695];

y3 = log(scy3);
lo3 = log(sclo3);
hi3 = log(schi3);

dt = max(t) - min(t);
[interiorbreak1,fval1] = fminbnd(@(b2) breakfit(b2,t+1,y1+1),min(t) + dt/100,max(t) - dt/100);
interiorbreak1

dt = max(t) - min(t);
[interiorbreak2,fval2] = fminbnd(@(b2) breakfit(b2,t+1,y2),min(t) + dt/100,max(t) - dt/100);
interiorbreak2

dt = max(t) - min(t);
[interiorbreak3,fval3] = fminbnd(@(b2) breakfit(b2,t+2,y3+2),min(t) + dt/100,max(t) - dt/100);
interiorbreak3
%%
figure(1);
% % COLORS FOR WT
h1 = plot(t,lo1,'-','color',[0.5 0.8 0.8],'LineWidth',1); %first set the boundaries of the CI
h2 = plot(t,hi1,'-','color',[0.5 0.8 0.8],'LineWidth',1);

f1 = [t, fliplr(t)]; %then fill in the area of the CI
inBetween = [lo1, fliplr(hi1)];
fill(f1, inBetween,[0.5 0.8 0.8],'LineStyle','none','FaceAlpha',0.3);

hold on

h3 = plot(t,lo2,'-','color',[0.3 0.5 0.4],'LineWidth',1); %first set the boundaries of the CI
h4 = plot(t,hi2,'-','color',[0.3 0.5 0.4],'LineWidth',1);
%'HandleVisibility','off'
f2 = [t, fliplr(t)]; %then fill in the area of the CI
inBetween = [lo2, fliplr(hi2)];
fill(f2, inBetween,[0.3 0.5 0.4],'LineStyle','none','FaceAlpha',0.3);

hold on

h5 = plot(t,lo3,'-','color',[0.1 0.0 0.2],'LineWidth',1); %first set the boundaries of the CI
h6 = plot(t,hi3,'-','color',[0.1 0.0 0.2],'LineWidth',1);

f3 = [t, fliplr(t)]; %then fill in the area of the CI
inBetween = [lo3, fliplr(hi3)];
fill(f3, inBetween,[0.1 0.0 0.2],'LineStyle','none','FaceAlpha',0.3);

% % COLORS FOR MT
% h1 = plot(t,lo1,'-','color',[1.0 1.0 0.6],'LineWidth',1); %first set the boundaries of the CI
% h2 = plot(t,hi1,'-','color',[1.0 1.0 0.6],'LineWidth',1);
% 
% f1 = [t, fliplr(t)]; %then fill in the area of the CI
% inBetween = [lo1, fliplr(hi1)];
% fill(f1, inBetween,[1.0 1.0 0.6],'LineStyle','none','FaceAlpha',0.3);
% 
% hold on
% 
% h3 = plot(t,lo2,'-','color',[1.0 0.4 0.2],'LineWidth',1); %first set the boundaries of the CI
% h4 = plot(t,hi2,'-','color',[1.0 0.4 0.2],'LineWidth',1);
% %'HandleVisibility','off'
% f2 = [t, fliplr(t)]; %then fill in the area of the CI
% inBetween = [lo2, fliplr(hi2)];
% fill(f2, inBetween,[1.0 0.4 0.2],'LineStyle','none','FaceAlpha',0.3);
% 
% hold on
% 
% h5 = plot(t,lo3,'-','color',[0.6 0.0 0.0],'LineWidth',1); %first set the boundaries of the CI
% h6 = plot(t,hi3,'-','color',[0.6 0.0 0.0],'LineWidth',1);
% 
% f3 = [t, fliplr(t)]; %then fill in the area of the CI
% inBetween = [lo3, fliplr(hi3)];
% fill(f3, inBetween,[0.6 0.0 0.0],'LineStyle','none','FaceAlpha',0.3);

% PLOT
hold on 

h13 = plot(t,y1,'-','color',[0.5 0.8 0.8],'LineWidth',3); hold on; %WT
% h13 = plot(t,y1,'-','color',[1.0 1.0 0.6],'LineWidth',3); hold on; %MT
h133=plot(round(interiorbreak1),y1(round(interiorbreak1+1)),'ko','LineWidth',3,'MarkerSize',12); 

h14 = plot(t,y2,'-','color',[0.3 0.5 0.4],'LineWidth',3); %WT
% h14 = plot(t,y2,'-','color',[1.0 0.4 0.2],'LineWidth',3); %MT
h144=plot(round(interiorbreak2),y2(round(interiorbreak2+1)),'ko','LineWidth',3,'MarkerSize',12); 

h15 = plot(t,y3,'-','color',[0.1 0.0 0.2],'LineWidth',3); %WT
% h15 = plot(t,y3,'-','color',[0.6 0.0 0.0],'LineWidth',3); %MT
h155=plot(round(interiorbreak3),y3(round(interiorbreak3+1)),'ko','LineWidth',3,'MarkerSize',12); 

hold off
title('SC+Glc TBR1'); 
% title('SC+Glc TBR1\Deltaa'); 
%title('TBR1 anc.'); 
ylabel('log(OD_{600})');xlabel('Time (hrs)');
legend([h13 h14 h15],{'0.5','1','2 % Glc'},'color','none','EdgeColor','none','Location','southeast');
%legend([h13 h14 h15 h16 h17 h18],{'0 \mug/mL','50 \mug/mL','75 \mug/mL','100 \mug/mL','125 \mug/mL','150 \mug/mL'},'EdgeColor','none','Location','northeastoutside');
%legend([h13 h14 h15 h16 h17 h18],{'0 %','0.02 %','0.04 %','0.06 %','0.08 %','0.1 %'},'EdgeColor','none','Location','northeastoutside');
set(gca,'color',[0.8 0.8 0.8],'FontSize',24,'LineWidth',3,'fontname','arial','xcolor','k','ycolor','k');
    %'XTickLabel',{'0','','20','','40'}); 
pbaspect([1 1 1]);
% ylim([-0.75 0.25]); xlim([-4 77]);
ylim([-2 1]); xlim([-4 77]);

% figure(2); %frame
% title('SC+Glc TBR1');
% set(gca,'color',[0.8 0.8 0.8],'FontSize',24,'LineWidth',3,'fontname','arial','xcolor','k','ycolor','k');
%     %'XTickLabel',{'0','','20','','40'}); 
% ylabel('log(OD_{600})');xlabel('Time (hrs)');
% pbaspect([1 1 1]); box on;
% ylim([-2 1]); xlim([-4 77]);
% hold off

%%
slopeat005=(y1(round(interiorbreak1+1))-y1(1))/interiorbreak1
slopeat010=(y2(round(interiorbreak1+1))-y1(1))/interiorbreak1
slopeat020=(y3(round(interiorbreak1+1))-y1(1))/interiorbreak1

LOGstatod005=mean(scy1(:,interiorbreak1:end))
LOGstatod010=mean(scy2(:,interiorbreak2:end))
LOGstatod020=mean(scy3(:,interiorbreak3:end))

function [err,fittedlines] = breakfit(interiorbreaks,x,y)
  % objective function to estimate the interior break of a simple broken
  % line fit. fittedlines is a cell array, containing the slope and
  % intercepts of the pair of fitted lines.
  
  % ensure that x and y are column vectors.
  x = x(:);
  y = y(:);
  
  nx = numel(x);
  
  breaks = [min(x),interiorbreaks,max(x)];
    
  % which points lie in which interval?
  xbins = discretize(x,breaks);
  
  % write the problem in matrix form
  A = [ones(nx,1),x - breaks(1),(x - breaks(2)).*(xbins == 2)];
  
  % we could use pinv here, but it would be slower then backslash, 
  % and I'll be careful to ensure the problem is not singular.
  coef = A\y;
  
  err = norm(y - A*coef);
  
  % unpack the coefficients so we can convert to a pair of line
  % coefficients. I'll do this in a fairly long form so it might be more
  % comprehensible.
  c1 = coef(1);
  s1 = coef(2);
  s2 = coef(3);
  b1 = breaks(1);
  b2 = breaks(2);
  fittedlines = {[s1,c1 - b1*s1],[s2 + s1,c1 - b2*s2]};
end